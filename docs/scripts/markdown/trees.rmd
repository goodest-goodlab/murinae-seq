---
#title: "Exome trees"
#author: "gwct"
#date: "06/19/2021"
output: 
  html_document:
    includes:
      in_header: '../html-chunks/rmd_header.html'
    df_print: paged
    code_folding: hide
---

```{r setup, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(ggplot2)
#library(cowplot)
#library(ggbeeswarm)
#library(ggpubr)
library(dplyr)
#library(kableExtra)
library(tidyr)
library(ggtree)
library(phytools)
library(vroom)
#source("../lib/design.r")
source("C:/bin/core/corelib/design.r")
source("C:/bin/core/get_tree_info.r")

htmltools::includeHTML("../html-chunks/rmd_nav.html")
```

# Full coding species tree

188 species. 11,775 coding loci. Gene trees reconstructed with IQ-tree and species topology with ASTRAL (no tip branch lengths).

```{r read, out.width="100%", fig.align = "center", warning=FALSE}
tree_file = "../../data/trees/full_coding_iqtree_astral.cf.rooted.tree"
#tree_file = "../data/trees/test.tre"
rodent_tree = read.tree(tree_file)

tree_info = treeToDF(rodent_tree)
tree_info = tree_info %>% separate(label, c("astral", "gcf", "scf"), sep="/", remove=F)
tree_info$astral[tree_info$node.type=="tip"] = NA
tree_info$astral = as.numeric(tree_info$astral)
tree_info$gcf = as.numeric(tree_info$gcf)
tree_info$scf = as.numeric(tree_info$scf)

#write.csv(tree_info, "../data/trees/full-coding-astral-cf-rooted.csv", row.names=F)

h = corecol(numcol=1, pal="wilke", offset=3)
l = corecol(numcol=1, offset=3)
# Colors
```

```{r fig1, out.width="100%", fig.align = "center", warning=FALSE, fig.height=16}
gcf_tree = ggtree(rodent_tree, size=0.8, ladderize=F, aes(color=tree_info$gcf)) +
  scale_color_continuous(name='gCF', low=l, high=h, limits=c(0,100)) +
  xlim(0, 31) +
  geom_tiplab(color="#333333", fontface='italic', size=2) +
  theme(legend.position=c(0.05,0.9))
#geom_text(aes(label=rodent_data$support), hjust=-.1, color="#006ddb") +
#geom_nodepoint(color="#666666", alpha=0.85, size=4)
print(gcf_tree)
#ggsave("../data/trees/gcf-tree.pdf", gcf_tree, width=8, height=16, unit="in")
# gCF tree
```

```{r fig2, out.width="100%", fig.align = "center", warning=FALSE, fig.height=16}
scf_tree = ggtree(rodent_tree, size=0.8, ladderize=F, aes(color=tree_info$scf)) +
  scale_color_continuous(name='sCF', low=l, high=h, limits=c(0,100)) +
  xlim(0, 31) +
  geom_tiplab(color="#333333", fontface='italic', size=2) +
  theme(legend.position=c(0.05,0.9))
#geom_text(aes(label=rodent_data$support), hjust=-.1, color="#006ddb") +
#geom_nodepoint(color="#666666", alpha=0.85, size=4)
print(scf_tree)
#ggsave("../data/trees/scf-tree.pdf", scf_tree, width=8, height=16, unit="in")
# sCF tree
```

```{r fig3, out.width="50%", fig.align = "center", warning=FALSE}
p = ggplot(tree_info, aes(x=gcf, y=scf, color=astral)) + 
  geom_point() +
  scale_color_continuous(name='Astral support', low=l, high=h, limits=c(0.8,1)) +
  bartheme() +
  theme(legend.title=element_text(size=12))
print(p)
```
```{r read-mg94local, out.width="50%", fig.align = "center", warning=FALSE}
mg94_local_file_gz = gzfile("../../data/rates/full-coding-mg94-local.csv.gz")
mg94_local = vroom(mg94_local_file_gz, comment="#")

mg94_local_gene = group_by(mg94_local, file) %>% summarize(dn=mean(dn, na.rm=T), ds=mean(ds, na.rm=T), dn.ds=mean("dn/ds", na.rm=T), nonsynonymous.bl=mean("nonsynonymous bl", na.rm=T), synonymous.bl=mean("synonymous bl", na.rm=T))

```

```{r fig4, out.width="50%", fig.align = "center", warning=FALSE}
ds_p = ggplot(subset(mg94_local_gene, ds < 0.05), aes(x=ds)) +
  geom_histogram(bins=50, fill=corecol(pal="wilke", numcol=1), color="#666666") +
  scale_y_continuous(expand=c(0,0)) +
  xlab("dS") +
  ylab("# of genes") +
  bartheme()
print(ds_p)
# Distribution of dS when using concatenated tree
```

```{r fig5, out.width="50%", fig.align = "center", warning=FALSE}
dn_p = ggplot(mg94_local_gene, aes(x=dn)) +
  geom_histogram(bins=50, fill=corecol(pal="wilke", numcol=1), color="#666666") +
  scale_y_continuous(expand=c(0,0)) +
  xlab("dN") +
  ylab("# of genes") +
  bartheme()
print(dn_p)
# Distribution of dS when using gene trees
```
```{r ds_filter, out.width="50%", fig.align = "center", warning=FALSE}
ds_filter_level = 0.03
print(paste("Removing genes with dS above ", ds_filter_level, " from subsequent analyses."))

ds_filter = subset(mg94_local_gene, ds > ds_filter_level)$file
# Get a list of genes to filter out in subsequent analyses based on dS
```

```{r ds_branch_avgs, out.width="50%", fig.align = "center", warning=FALSE}
### I THINK I SHOULD DO THIS IN PYTHON
tree_info$avg.ds = "NA"
tree_info$avg.dn = "NA"
tree_info$avg.dn.ds = "NA"
tree_info$avg.synonymous.bl = "NA"
tree_info$avg.nonsynonymous.bl = "NA"
tree_info$num.genes.full = 0
tree_info$num.genes.partial = 0

for(i in 1:nrow(tree_info)) {
  cur_clade = strsplit(tree_info[i,]$clade, ";")
  print(cur_clade)
  if(tree_info[i,]$node.type == 'tip'){
    next
  }
  
  for(j in 1:nrow(mg94_local)){
    row = mg94_local[j,]
    if(row$file %in% ds_filter){
      break
    }
    
    split1 = strsplit(row$split1, ";")
    split2 = strsplit(row$split2, ";")
    

    
    if(all(split1 %in% cur_clade)){

      if(length(split1) == length(cur_clade)){
        tree_info[i,]$num.genes.full = tree_info[i,]$num.genes.full + 1

      }else{
        not_in_split1 = setdiff(cur_clade, split1)
        
        if(!any(not_in_split1 %in% split2)){
          print(split1)
          print(split2)        
          stop("eya")
          tree_info[i,]$num.genes.partial = tree_info[i,]$num.genes.partial + 1
        }
        
        
      }
      
      
      
    }
    
    
    
  }
  
  
}

```

```{r footer}
cat("Page last updated:", format(Sys.time(), "%m/%d/%Y %H:%M:%S %Z"))
htmltools::includeHTML("../html-chunks/rmd_footer.html")
```